@page "/auth/verify-email"
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Conflux.Database
@using Conflux.Database.Entities
@using Conflux.Services
@using System.Diagnostics
@using System.Text

@inject NavigationManager NavigationManager
@inject ApplicationRedirectManager RedirectManager
@inject IJSRuntime JavascriptRuntime
@inject UserManager<ApplicationUser> UserManager

@* The background element *@
<div class="h-screen w-screen bg-blue-400 grid grid-cols-1 px-4 md:px-0 md:grid-cols-4 lg:grid-cols-3">
    <div class="col-start-1 col-span-1 md:col-start-2 md:col-span-2 lg:col-start-2 lg:col-span-1">
        <div class="size-full flex flex-col justify-center items-center">
            <div class="bg-gray-700 w-full rounded-3xl shadow-xl text-white overflow-hidden relative">
                <div class="absolute rounded-t-3xl w-full h-1 panel-accent-color-1"></div>
                
                <div class="p-10">
                    <h1 class="text-center font-bold text-3xl text-white">Almost there</h1>
                    <p class="text-center text-gray-400 text-sm mt-2">Finish the next step to become one of us</p>
                    
                    <button type="button" class="mt-8 text-white font-semibold rounded-lg w-full h-11 shadow-md bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 cursor-pointer" @onclick="SendVerificationEmail">
                        Send verification email
                    </button>
                </div>
            </div>
            
            @if (ShowConfirmationButton) {
                <div class="bg-gray-700 w-full rounded-3xl shadow-xl text-white overflow-hidden relative mt-4">
                    <div class="absolute rounded-t-3xl w-full h-1 panel-accent-color-1"></div>
                
                    <div class="p-10">
                        <h1 class="text-center font-bold text-3xl text-white">Lmao</h1>
                        <p class="text-center text-gray-400 text-sm mt-2">No email system yet, just press to confirm</p>
                    
                        <button type="button" class="mt-8 text-white font-semibold rounded-lg w-full h-11 shadow-md bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 cursor-pointer" @onclick="ConfirmAccount">
                            Confirm account
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "userId")] public string? UserId { get; set; }

    public bool ShowConfirmationButton { get; private set; }

    private ApplicationUser? _user;

    protected override async Task OnInitializedAsync() {
        if (UserId == null) {
            RedirectManager.To("/").Execute();
            return;
        }
        
        _user = await UserManager.FindByIdAsync(UserId);

        if (_user == null || await UserManager.IsEmailConfirmedAsync(_user)) {
            RedirectManager.To("/").Execute();
            return;
        }
    }

    private async Task SendVerificationEmail() {
        await JavascriptRuntime.InvokeVoidAsync("open", "https://www.youtube.com/watch?v=dQw4w9WgXcQ");
        ShowConfirmationButton = true;
    }

    private async Task ConfirmAccount() {
        Debug.Assert(_user != null);
        
        string confirmationCode = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(await UserManager.GenerateEmailConfirmationTokenAsync(_user)));
        
        // TODO: Put the confirmation code into email as an url to other page and send it away.
        RedirectManager.To("/auth/confirm-email").WithQuery("userId", UserId).WithQuery("code", confirmationCode).Execute();
    }
}