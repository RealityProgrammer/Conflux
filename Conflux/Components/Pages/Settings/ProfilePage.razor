@page "/settings/profile"

@using Conflux.Components.Services
@using Conflux.Components.Services.Abstracts
@using Conflux.Database
@using Conflux.Database.Entities
@using System.Diagnostics

@inject IWebHostEnvironment Environment
@inject IAccountService AccountService
@inject ApplicationRedirectManager RedirectManager
@inject ILogger<ProfilePage> Logger
@inject PersistentComponentState ApplicationState

@rendermode @(new InteractiveServerRenderMode(prerender: false))

@if (_user == null) {
    <div class="flex flex-col h-full">
        <h1 class="font-bold text-3xl flex-none">Profile Management</h1>
        
        <div class="flex-1 flex flex-row justify-center items-center">
            <div class="animate-bounce">
                <p class="font-bold animate-pulse">Loading profile...</p>
            </div>
        </div>
    </div>

    return;
}

<h1 class="font-bold text-3xl">Profile Management</h1>

<div class="mt-3 mx-0 w-full md:mx-auto md:w-2/3 lg:w-3/4 grid grid-cols-1 lg:grid-cols-[40%_60%] border border-gray-800 shadow-lg rounded-lg">
    @* <section class="w-full h-16 border-r border-r-gray-600"> *@
    @*     <div class="relative w-full h-32"> *@
    @*         <img src="https://picsum.dev/300/200" alt="Banner Image" class="object-cover size-full"> *@
    @*     </div> *@
    @* </section> *@
    
    <section class="pb-2 border-r border-r-gray-600">
        @* Banner and Profile Picture *@
        <div class="relative h-32">
            <div class="absolute inset-0 bg-cover bg-center bg-black rounded-tl-lg">
            </div>

            <div class="absolute -bottom-8 left-4">
                <div class="relative">
                    <div class="w-20 h-20 rounded-full border-4 border-gray-800 bg-gray-700 overflow-hidden">
                        @{
                            int id = Random.Shared.Next(0, 100);

                        }

                        <img src="https://randomuser.me/api/portraits/men/@(id).jpg"
                             alt="Profile"
                             class="w-full h-full object-cover">
                    </div>

                    @* TODO: Status indicator *@
                </div>
            </div>
        </div>
        
        @* Username, Bio, etc... *@
        <div class="px-2 mt-10">
            <p class="font-semibold text-xl">@_user.UserName</p>
        </div>
    </section>
    
    <section class="w-full h-16">
        <p>Content</p>
    </section>
</div>

@code {
    private ApplicationUser? _user;

    protected override async Task OnInitializedAsync() {
        Logger.LogInformation("OnInitialized");
        
        if (Environment.IsDevelopment()) {
            await Task.Delay(1500);
        }
        
        if (await AccountService.GetCurrentUserAsync() is not { } user) {
            // How did we get here? Pretty sure [Authorize] at _Imports.razor should redirect to login if there is no
            // current user.
            RedirectManager.To("/auth/login").Execute();
            return;
        }
        
        _user = user;
    }

    // protected override async Task OnAfterRenderAsync(bool firstRender) {
    //     if (!firstRender) {
    //         if (Environment.IsDevelopment()) {
    //             await Task.Delay(1500);
    //         }
    //
    //         if (await AccountService.GetCurrentUserAsync() is not { } user) {
    //             // How did we get here? Pretty sure [Authorize] at _Imports.razor should redirect to login if there is no
    //             // current user.
    //
    //             RedirectManager.To("/auth/login").Execute();
    //             return;
    //         }
    //
    //         _user = user;
    //         Logger.LogInformation("User Loaded");
    //     }
    // }
}