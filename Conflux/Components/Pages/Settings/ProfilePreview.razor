@using Conflux.Components.Shared
@using Conflux.Database.Entities
@using Conflux.Services
@using Conflux.Services.Abstracts
@using Markdig

@inject MarkdownPipeline MarkdownPipeline
@inject ProfileSanitizingService SanitizingService
@inject IContentService ContentService

<div class="mt-3 mx-0 w-full md:mx-auto md:w-2/3 lg:w-3/4 grid grid-cols-1 lg:grid-cols-[40%_60%] border border-gray-800 shadow-lg rounded-lg">
    <section class="pb-2 border-b border-b-gray-600 lg:border-r lg:border-r-gray-600 lg:border-b-0">
        @* Avatar and Banner *@
        <div class="relative h-32">
            <div class="absolute inset-0 bg-cover bg-center bg-black rounded-tl-lg rounded-tr-lg lg:rounded-tr-none"></div>

            <div class="absolute -bottom-8 left-4">
                <div class="relative">
                    @{
                        string? displayImageSrc = Model.Avatar.RequestDelete ? null : AvatarPreviewUrl ?? (string.IsNullOrEmpty(User.AvatarProfilePath) ? null : ContentService.GetAssetPath(User.AvatarProfilePath));
                    }
                                    
                    <Avatar class="size-20 border-4 border-gray-700" ImageSrc="@displayImageSrc" ImageAlt="Preview Avatar"/>

                    @* TODO: Status indicator *@
                </div>
            </div>
        </div>

        @* Username, Bio, etc... *@
        <div class="px-2 pt-10">
            <p class="text-2xl font-bold">@Model.DisplayName</p>
            <p class="text-sm">@User.UserName</p>

            <p class="mt-2 text-sm">
                <span class="font-semibold">Joined since:</span> @User.CreatedAt.ToString("yyyy/MM/dd")
            </p>

            @if (Model.Pronouns is { } pronouns) {
                <p class="text-sm mt-2">
                    <span class="font-semibold">Pronouns:</span>

                    @pronouns
                </p>
            }
        </div>
    </section>

    <section class="w-full p-4">
        @if (!string.IsNullOrEmpty(_markupBio.Value)) {
            @_markupBio
        } else {
            <div class="size-full flex justify-center items-center">
                <p class="text-sm text-gray-400">Well this is awkward...</p>
            </div>
        }
    </section>
</div>

@code {
    [Parameter, EditorRequired] public required ProfileInputModel Model { get; set; }
    [Parameter, EditorRequired] public required ApplicationUser User { get; set; }
    [Parameter, EditorRequired] public required string? AvatarPreviewUrl { get; set; }
    
    private MarkupString _markupBio;

    protected override void OnAfterRender(bool firstRender) {
        if (firstRender) {
            if (string.IsNullOrWhiteSpace(Model.Bio)) {
                _markupBio = new(string.Empty);
                return;
            }

            var document = Markdown.Parse(Model.Bio, MarkdownPipeline);
            _markupBio = (MarkupString)SanitizingService.Sanitize(document.ToHtml(MarkdownPipeline));
            
            StateHasChanged();
        }
    }
}