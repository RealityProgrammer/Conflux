@page "/lobby/activity"

@using Conflux.Components.Shared
@using Conflux.Components.Shared.Icons
@using Conflux.Components.Shared.Modals
@using Conflux.Database
@using Conflux.Database.Entities
@using Conflux.Services
@using Conflux.Services.Abstracts
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims

@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject IContentService ContentService
@inject ApplicationRedirectManager RedirectManager
@inject ModalService ModalService

@switch (_state) {
    case State.Loading:
        <div class="flex justify-center items-center size-full">
            <Spinner class="size-8 fill-white"/>
        </div>
        break;
        
    case State.Success:
        <div class="p-4 text-white">
            <header class="flex-none border-b border-b-gray-600 pb-2">
                <h1 class="text-2xl font-bold">Activity</h1>
            </header>
        
            <section class="mt-3">
                <h1 class="text-xl font-semibold">Status</h1>
                <p class="text-sm text-gray-400 mb-3">Let others know you are or aren't up for conversation.</p>
        
                <div class="flex flex-col sm:flex-col justify-center items-center w-full md:w-160 mx-auto">
                    <div class="relative h-16 z-10 w-full group" @onclick="HandleOpenStatusModal">
                        <div class="absolute inset-0 bg-white group-hover:bg-gray-300 rounded-full flex flex-row justify-center items-center p-4 cursor-pointer">
                            @if (string.IsNullOrEmpty(_userInfo.Status)) {
                                <p class="text-sm text-gray-700 animate-bounce">&lt;No thoughts head empty...&gt;</p>
                            } else {
                                <p class="text-black text-center">@_userInfo.Status</p>
                            }
                        </div>
        
                        <div class="absolute left-1/2 bottom-0 -translate-x-1/2 translate-y-1/2 rotate-45 size-4 border-r-2 bg-white group-hover:bg-gray-300"></div>
                    </div>
        
                    <Avatar class="size-64 mt-2 shadow-lg flex-none mx-auto" ImageSrc="@(string.IsNullOrEmpty(_userInfo.AvatarPath) ? null : ContentService.GetAssetPath(_userInfo.AvatarPath))"/>
                </div>
            </section>
        </div>
        break;
}

@code {
    private State _state;

    private UserInformationDTO _userInfo;

    [CascadingParameter] private Task<AuthenticationState> AuthenticationState { get; set; } = null!;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            var authState = await AuthenticationState;
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (userId == null) {
                RedirectManager.To("/").Execute();
                return;
            }
            
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            dbContext.ChangeTracker.QueryTrackingBehavior = QueryTrackingBehavior.NoTracking;

            _userInfo = await dbContext.Users
                .Where(x => x.Id == userId)
                .Select(x => new UserInformationDTO(x.AvatarProfilePath, x.StatusText))
                .FirstOrDefaultAsync();
            
            _state = State.Success;
            StateHasChanged();
        }
    }

    private void HandleOpenStatusModal() {
        ModalService.Add<StatusModal>();
    }

    private enum State {
        Loading,
        Success,
    }

    private record struct UserInformationDTO(string? AvatarPath, string? Status);
}