@page "/lobby/activity"

@using Conflux.Components.Shared
@using Conflux.Components.Shared.Icons
@using Conflux.Components.Shared.Modals
@using Conflux.Infrastructure.Data
@using Conflux.Services
@using Conflux.Services.Abstracts
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims

@implements IDisposable

@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject IContentService ContentService
@inject ApplicationRedirectManager RedirectManager
@inject ModalService ModalService
@inject ILogger<ActivityPage> Logger

@switch (_state) {
    case State.Loading:
        <div class="flex justify-center items-center size-full">
            <Spinner class="size-8 fill-white"/>
        </div>
        break;
        
    case State.Success:
        <div class="p-4 text-white">
            <header class="flex-none border-b border-b-gray-600 pb-2">
                <h1 class="text-2xl font-bold">Activity</h1>
            </header>
        
            <section class="mt-3">
                <h1 class="text-xl font-semibold">Status</h1>
                <p class="text-sm text-gray-400 mb-3">Let others know you are or aren't up for conversation.</p>
        
                <div class="flex flex-col sm:flex-col justify-center items-center w-full md:w-160 mx-auto">
                    <div class="relative h-16 z-10 w-full group" @onclick="HandleOpenStatusModal">
                        <div class="absolute inset-0 bg-white group-hover:bg-gray-300 rounded-full flex flex-row justify-center items-center p-4 cursor-pointer">
                            @if (string.IsNullOrEmpty(_userStatus)) {
                                <p class="text-sm text-gray-700 animate-bounce">&lt;No thoughts head empty...&gt;</p>
                            } else {
                                <p class="text-black text-center">@_userStatus</p>
                            }
                        </div>
        
                        <div class="absolute left-1/2 bottom-0 -translate-x-1/2 translate-y-1/2 rotate-45 size-4 border-r-2 bg-white group-hover:bg-gray-300"></div>
                    </div>
        
                    <Avatar class="size-64 mt-2 shadow-lg flex-none mx-auto" ImageSrc="@(string.IsNullOrEmpty(_userAvatar) ? null : ContentService.GetAssetPath(_userAvatar))"/>
                </div>
            </section>
        </div>
        break;
}

@code {
    private State _state;

    private string? _userAvatar, _userStatus;

    [CascadingParameter] private Task<AuthenticationState> AuthenticationState { get; set; } = null!;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            var authState = await AuthenticationState;
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (userId == null) {
                RedirectManager.To("/").Execute();
                return;
            }
            
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            dbContext.ChangeTracker.QueryTrackingBehavior = QueryTrackingBehavior.NoTracking;

            var data = await dbContext.Users
                .Where(x => x.Id == userId)
                .Select(x => new { x.AvatarProfilePath, x.StatusText })
                .FirstOrDefaultAsync();

            _userAvatar = data!.AvatarProfilePath;
            _userStatus = data.StatusText;
            
            _state = State.Success;
            StateHasChanged();

            ModalService.OnModalChanged += OnModalChanged;
        }
    }

    private void HandleOpenStatusModal() {
        ModalService.Open<StatusModal>(name: "Activity.Status");
    }

    private void OnModalChanged(ModalChangedEventArgs args) {
        if (args is not { Type: ModalChangedEventType.Closed, Instance.Name: "Activity.Status", ReturnValue: string returnValue }) {
            return;
        }

        _userStatus = returnValue;
        StateHasChanged();
    }

    public void Dispose() {
        ModalService.OnModalChanged -= OnModalChanged;
    }

    private enum State {
        Loading,
        Success,
    }
}