@page "/community/{CommunityId:guid}/{Channel?}"

@using Conflux.Components.Layout
@using Conflux.Core
@using Conflux.Services.Abstracts
@using Microsoft.AspNetCore.Components.Sections
@using System.Security.Claims

@layout SidebarLobbyLayout

@inject ICommunityService CommunityService

@implements IAsyncDisposable

<CascadingValue Value="_memberRole">
    <SectionContent SectionName="lobby-sidebar">
        <ChannelSidebar CommunityId="CommunityId"/>
    </SectionContent>

    @switch (Channel) {
        case "welcome" or null:
            <div class="flex justify-center items-center h-full">
                <p class="text-sm text-gray-400">Customizable WELCOME page is currently being constructed.</p>
            </div>
            break;

        case "events":
            <div class="flex justify-center items-center h-full">
                <p class="text-sm text-gray-400">Customizable EVENTS page is currently being constructed.</p>
            </div>
            break;

        case "rules":
            <div class="flex justify-center items-center h-full">
                <p class="text-sm text-gray-400">Customizable RULES page is currently being constructed.</p>
            </div>
            break;

        case var _ when Guid.TryParse(Channel, out var channelId):
            <ChannelContentInterface CommunityId="CommunityId" ChannelId="channelId"/>
            break;
            
        default:
            <div class="flex justify-center items-center h-full">
                <p class="text-sm text-gray-400">Hmmm how did you get here?</p>
            </div>
            break;
    }
</CascadingValue>

@code {
    [Parameter] public Guid CommunityId { get; set; }
    private Guid _previousCommunityId;
    
    [Parameter] public string? Channel { get; set; }

    private MemberRolePermissions? _memberRole;

    [CascadingParameter] private Task<AuthenticationState> AuthenticationState { get; set; } = null!;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (_previousCommunityId != CommunityId) {
            await CommunityService.LeaveCommunityHubAsync(_previousCommunityId);
            await CommunityService.JoinCommunityHubAsync(CommunityId);

            var authState = await AuthenticationState;
            var userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier)!;
            
            _memberRole = await CommunityService.GetUserRolePermissionsAsync(userId, CommunityId);

            StateHasChanged();
            _previousCommunityId = CommunityId;
        }
    }
    
    public async ValueTask DisposeAsync() {
        await CommunityService.LeaveCommunityHubAsync(CommunityId);
    }
}