@page "/community/{CommunityId:guid}/{ChannelId:guid}"

@using Conflux.Components.Layout
@using Conflux.Components.Shared
@using Conflux.Components.Shared.Icons
@using Conflux.Database
@using Conflux.Database.Entities
@using Conflux.Services.Abstracts
@using Microsoft.EntityFrameworkCore

@layout CommunityLayout

@implements IAsyncDisposable

@inject ICommunityService CommunityService
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

@switch (_initState) {
    case InitializationState.Initializing:
        <div class="size-full flex flex-row justify-center items-center">
            <Spinner class="size-8 fill-white"/>
        </div>
        break;
        
    case InitializationState.InvalidChannel:
        <div class="size-full flex flex-row justify-center items-center">
            <p class="text-gray-400">Nothing here...</p>
        </div>
        break;
        
    case InitializationState.Success:
        <div class="flex flex-col h-full">
            @switch (_channelData.Type) {
                case CommunityChannelType.Text:
                    <header class="flex-none p-1.5 border-b border-b-gray-600 bg-gray-725 flex flex-row items-center">
                        Header
                    </header>
                    
                    <MessagingArea class="flex-1 h-full" ConversationId="_channelData.ConversationId" LoadCount="ApplicationConstants.MessageLoadCount"/>
                    break;
                    
                case CommunityChannelType.Audio:
                    <div class="flex-1 flex flex-row justify-center items-center">
                        <p class="text-gray-400">Audio channel is currently WIP.</p>
                    </div>
                    break;
            }
        </div>
        break;
}

@code {
    [Parameter] public Guid CommunityId { get; set; }
    [Parameter] public Guid ChannelId { get; set; }
    
    [CascadingParameter] private CommunityLayout CommunityLayout { get; set; } = null!;

    private InitializationState _initState;
    private ChannelDTO _channelData;
    
    protected override void OnInitialized() {
        CommunityLayout.CommunityId = CommunityId;
        _initState = InitializationState.Initializing;
    }

    protected override void OnParametersSet() {
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();

            _channelData = await dbContext.CommunityChannels
                .Where(x => x.Id == ChannelId)
                // .Where(x => x.ChannelCategory.CommunityId == CommunityId)
                .Select(x => new ChannelDTO(x.Conversation.Id, x.Type))
                .FirstOrDefaultAsync();

            _initState = _channelData.ConversationId != Guid.Empty ? InitializationState.Success : InitializationState.InvalidChannel;
            StateHasChanged();
        }
    }
    
    public async ValueTask DisposeAsync() {
        await CommunityService.LeaveCommunityHubAsync(CommunityId);
    }

    private enum InitializationState {
        Initializing,
        InvalidChannel,
        Success,
    }

    private record struct ChannelDTO(Guid ConversationId, CommunityChannelType Type);
}