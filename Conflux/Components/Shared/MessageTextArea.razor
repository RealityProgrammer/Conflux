@inherits InputTextArea
@implements IAsyncDisposable

@inject IJSRuntime JavascriptRuntime
@inject ILogger<MessageTextArea> Logger

<textarea @ref="Element"
    class="@CssClass"
    rows="1"
    placeholder="Enter the message..."
    @bind="CurrentValueAsString" @bind:event="oninput"
    @attributes="AdditionalAttributes">
</textarea>

@code {
    [Parameter] public EventCallback OnEnterSubmit { get; set; }
    [Parameter] public EventCallback OnEscape { get; set; }
    
    private IJSObjectReference? _module;
    private DotNetObjectReference<MessageTextArea>? _objectReference;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            _module = await JavascriptRuntime.InvokeAsync<IJSObjectReference>("import",
                "./Components/Shared/MessageTextArea.razor.js");
        
            _objectReference = DotNetObjectReference.Create(this);
            await _module.InvokeVoidAsync("initializeTextArea", Element, _objectReference);
            
            // TODO: Fix this hacky way to make it resize when we start editing.
            await _module!.InvokeVoidAsync("resizeTextArea", Element);
        }
    }

    [JSInvokable]
    public async Task HandleEnterSubmit() {
        if (OnEnterSubmit.HasDelegate) {
            await OnEnterSubmit.InvokeAsync();

            CurrentValueAsString = null;
            await ValueChanged.InvokeAsync(null);
        }
    }

    [JSInvokable]
    public async Task HandleEscapeRequest() {
        if (OnEscape.HasDelegate) {
            await OnEnterSubmit.InvokeAsync();
        }
    }
    
    public async ValueTask DisposeAsync() {
        if (_module is not null) {
            try {
                await _module.DisposeAsync();
            } catch (JSDisconnectedException) {
            }
        }

        _objectReference?.Dispose();
    }
}