@using Conflux.Components.Shared.Icons
@using Conflux.Database
@using Conflux.Database.Entities
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims

@implements IAsyncDisposable

@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject IJSRuntime JavascriptRuntime
@inject ILogger<ConversationMessageHistory> Logger

@switch (_initStatus) {
    case InitializationStatus.Initializing:
        <div class="size-full flex flex-row justify-center items-center">
            <Spinner class="size-16 fill-white"/>
        </div>
        break;
        
    case InitializationStatus.NoPermission:
        <div class="size-full flex flex-row justify-center items-center">
            <p class="text-sm text-gray-400">You have no permission to join this conversation.</p>
        </div>
        break;
        
    case InitializationStatus.Success:
        <div class="overflow-y-auto px-2 @_cssClass" @ref="_scrollContainer">
            <header class="p-3 pb-0 mb-2">
                <p class="font-semibold text-white text-xl text-center">This is the message timeline. Be a part of it, or sneak in and listen...</p>
        
                <hr class="border-t border-t-gray-600 mt-2"/>
            </header>
    
            @if (_loadingTop) {
                <div class="flex flex-row items-center justify-center">
                    <Spinner class="size-6 fill-white"/>
                </div>
            }
    
            <div>
                @for (int i = _visibleMessages.Count - 1; i >= 0; i--) {
                    ChatMessage message = _visibleMessages[i];
                    
                    <div class="group flex flex-row mb-2">
                        <Avatar ImageSrc="@message.Sender.AvatarProfilePath" 
                                ImageAlt="@(string.IsNullOrEmpty(message.Sender.AvatarProfilePath) ? string.Empty : "Sender Avatar")" 
                                ScaleX="message.Sender.AvatarScaleX"
                                ScaleY="message.Sender.AvatarScaleY"
                                class="size-10 mr-2"/>
                
                        <div class="flex flex-col">
                            <p>@message.Sender.DisplayName</p>
                            <p>@message.Body</p>
                        </div>
                    </div>
                }
            </div>
    
            @if (_loadingBottom) {
                <div class="flex flex-row items-center justify-center">
                    <Spinner class="size-6 fill-white"/>
                </div>
            }
        </div>
        break;
}

@code {
    [Parameter, EditorRequired] public required Guid ConversationId { get; set; }
    [Parameter] public EventCallback<InitializationStatus> OnInitializeLoaded { get; set; }

    [Parameter(CaptureUnmatchedValues = true)] public IReadOnlyDictionary<string, object>? AdditionalAttributes { get; set; }
    private string? _cssClass;
    
    [CascadingParameter] private Task<AuthenticationState> AuthenticationState { get; set; } = null!;
    private string _userId = null!;

    private InitializationStatus _initStatus = InitializationStatus.Initializing;
    private bool _loadingTop, _loadingBottom;
    private ElementReference _scrollContainer;
    private List<ChatMessage> _visibleMessages = [];
    private DateTime _loadingTimestamp;
    
    private IJSObjectReference? _module;
    private DotNetObjectReference<ConversationMessageHistory>? _objectReference;

    protected override void OnParametersSet() {
        if (AdditionalAttributes != null && AdditionalAttributes.TryGetValue("class", out object? obj)) {
            _cssClass = Convert.ToString(obj);
        }

        AdditionalAttributes = AdditionalAttributes?.Where(x => x.Key is not "class").ToDictionary();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            _module = await JavascriptRuntime.InvokeAsync<IJSObjectReference>("import",  "./Components/Shared/ConversationMessageHistory.razor.js");
            
            try {
                var authState = await AuthenticationState;
                _userId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier)!;

                if (string.IsNullOrEmpty(_userId)) {
                    _initStatus = InitializationStatus.NoPermission;
                    return;
                }

                await using (var dbContext = await DbContextFactory.CreateDbContextAsync()) {
                    dbContext.ChangeTracker.QueryTrackingBehavior = QueryTrackingBehavior.NoTracking;
                    
                    // Load and validate conversation.
                    // _conversation = await dbContext.Conversations.Where(c => c.Id == ConversationId).FirstOrDefaultAsync();
                
                    // Load Initial messages
                    IAsyncEnumerable<ChatMessage> initialMessages = dbContext.ChatMessages
                        .Where(msg => msg.ConversationId == ConversationId)
                        .OrderByDescending(msg => msg.CreatedAt)
                        .Take(20)
                        .Include(message => message.Sender)
                        .AsAsyncEnumerable();

                    await foreach (var message in initialMessages) {
                        _visibleMessages.Add(message);
                    }

                    _loadingTimestamp = _visibleMessages[0].CreatedAt;
                    _initStatus = InitializationStatus.Success;
                }

                _loadingTop = _loadingBottom = false;
            } finally {
                StateHasChanged();

                if (OnInitializeLoaded.HasDelegate) {
                    await OnInitializeLoaded.InvokeAsync(_initStatus);
                }
            }

            await Task.Yield(); // Might need this, probably...

            _objectReference = DotNetObjectReference.Create(this);

            await _module.InvokeVoidAsync("scrollToBottom", _scrollContainer);
            await _module.InvokeVoidAsync("initializeScrollContainer", _scrollContainer, _objectReference);
        }
    }

    [JSInvokable]
    public async Task HandleLoadTopMessages() {
        if (Interlocked.Exchange(ref _loadingTop, true)) return;

        await InvokeAsync(StateHasChanged);

        await using (var dbContext = await DbContextFactory.CreateDbContextAsync()) {
            IAsyncEnumerable<ChatMessage> loadedMessages = dbContext.ChatMessages
                .Where(msg => msg.ConversationId == ConversationId)
                .OrderByDescending(msg => msg.CreatedAt)
                .Where(m => m.CreatedAt < _loadingTimestamp)
                .Take(20)
                .Include(message => message.Sender)
                .AsAsyncEnumerable();
        }
        
        Interlocked.Exchange(ref _loadingBottom, false);
        await InvokeAsync(StateHasChanged);
    }
    
    [JSInvokable]
    public async Task HandleLoadBottomMessages() {
        // if (Interlocked.Exchange(ref _loadingBottom, true)) return;
        
        Logger.LogInformation("Load more bottom messages...");

        // Interlocked.Exchange(ref _loadingBottom, false);
    }
    
    public async ValueTask DisposeAsync() {
        if (_module is not null) {
            try {
                await _module.DisposeAsync();
            } catch (JSDisconnectedException) {
            }
        }
        
        _objectReference?.Dispose();
    }

    public enum InitializationStatus {
        Initializing,
        NoPermission,
        Success,
    }
}