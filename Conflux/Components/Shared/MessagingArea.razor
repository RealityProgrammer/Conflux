<section class="flex flex-col @_cssClass">
    @* Loading state will be handled by the ConversationMessageHistory *@
    <ConversationMessageHistory @ref="MessageHistoryElement"
                                class="flex-1 basis-auto"
                                ConversationId="ConversationId!.Value"
                                OnInitializeLoaded="HandleInitializeLoaded"
                                OverloadCount="ApplicationConstants.MessageLoadCount"/>

    <MessageInputArea class="flex-none p-2 flex flex-row items-center gap-1"
                      disabled="@(!_isConversationLoaded)"
                      OnSubmit="@OnMessageSendRequest"/>
    
    <div class="flex-none flex flex-row gap-1">
        <button class="button-primary">
            Jump to random
        </button>
    </div>
</section>

@code {
    [Parameter] public EventCallback<string> OnMessageSendRequest { get; set; }
    [Parameter, EditorRequired] public required Guid? ConversationId { get; set; }
    
    public ConversationMessageHistory? MessageHistoryElement { get; private set; }

    private bool _isConversationLoaded = false;
    
    [Parameter(CaptureUnmatchedValues = true)] public IReadOnlyDictionary<string, object>? AdditionalAttributes { get; set; }
    private string? _cssClass;
    
    protected override void OnParametersSet() {
        if (AdditionalAttributes != null && AdditionalAttributes.TryGetValue("class", out object? obj)) {
            _cssClass = Convert.ToString(obj);
        }

        AdditionalAttributes = AdditionalAttributes?.Where(x => x.Key is not "class").ToDictionary();
    }
   
    private void HandleInitializeLoaded(ConversationMessageHistory.InitializationStatus status) {
        if (status == ConversationMessageHistory.InitializationStatus.Success) {
            _isConversationLoaded = true;
            InvokeAsync(StateHasChanged);
        }
    }
}