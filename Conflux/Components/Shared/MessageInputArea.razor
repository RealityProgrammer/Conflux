@using Conflux.Components.Shared.Icons
@using Conflux.Database
@using Microsoft.EntityFrameworkCore

@implements IAsyncDisposable

@inject IJSRuntime JavascriptRuntime
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject ILogger<MessageInputArea> Logger

<footer class="flex flex-row items-end gap-1 @_cssClass" @attributes="AdditionalAttributes">
    <section class="flex-1 flex flex-col min-w-0">
        @if (_replyMessageId.HasValue) {
            <div class="min-w-0 rounded-t-lg py-1 px-2 border-x border-x-gray-600 border-t border-t-gray-600 flex flex-row items-center gap-1 overflow-hidden">
                <p class="flex-1 whitespace-nowrap overflow-hidden text-ellipsis">Replying to @_replyMessageData.AuthorDisplayName: "@_replyMessageData.MessageBody"</p>

                <button class="flex-none p-0.5 bg-transparent hover:bg-white/15 rounded-full" @onclick="HandleCancelReply">
                    <Cross class="size-4 fill-white"/>
                </button>
            </div>
        }
        
        @if (_uploadingFiles.Count > 0) {
            <ul class="min-w-0 p-2 pb-3 border-x border-x-gray-600 border-t border-t-gray-600 overflow-x-auto overflow-y-visible flex flex-row justify-start items-center gap-1.5 @(_replyMessageId.HasValue ? string.Empty : "rounded-t-lg")">
                @for (int i = 0; i < _uploadingFiles.Count; i++) {
                    UploadingFile uploadingFile = _uploadingFiles[i];
                    
                    <li class="flex-none group relative">
                        <div class="overflow-hidden rounded-lg border border-gray-600">
                            <div class="size-48 relative group">
                                @{ string contentType = uploadingFile.BrowserFile.ContentType; }
                                
                                @switch (contentType) {
                                    case var _ when contentType.StartsWith("image/"):
                                        <img src="@uploadingFile.PreviewUrl" alt="Preview image for @uploadingFile.BrowserFile.Name" class="size-full object-cover pointer-events-none">
                                        break;
                                        
                                    case var _ when contentType.StartsWith("audio/"):
                                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" class="absolute top-1/2 left-1/2 -translate-1/2 size-32 fill-none stroke-white stroke-2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="m9 9 10.5-3m0 6.553v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 1 1-.99-3.467l2.31-.66a2.25 2.25 0 0 0 1.632-2.163Zm0 0V2.25L9 5.25v10.303m0 0v3.75a2.25 2.25 0 0 1-1.632 2.163l-1.32.377a1.803 1.803 0 0 1-.99-3.467l2.31-.66A2.25 2.25 0 0 0 9 15.553Z" />
                                        </svg>
                                        break;
                                        
                                    case var _ when contentType.StartsWith("video/"):
                                        <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" class="absolute top-1/2 left-1/2 -translate-1/2 size-32 fill-none stroke-white stroke-2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h1.5C5.496 19.5 6 18.996 6 18.375m-3.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-1.5A1.125 1.125 0 0 1 18 18.375M20.625 4.5H3.375m17.25 0c.621 0 1.125.504 1.125 1.125M20.625 4.5h-1.5C18.504 4.5 18 5.004 18 5.625m3.75 0v1.5c0 .621-.504 1.125-1.125 1.125M3.375 4.5c-.621 0-1.125.504-1.125 1.125M3.375 4.5h1.5C5.496 4.5 6 5.004 6 5.625m-3.75 0v1.5c0 .621.504 1.125 1.125 1.125m0 0h1.5m-1.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m1.5-3.75C5.496 8.25 6 7.746 6 7.125v-1.5M4.875 8.25C5.496 8.25 6 8.754 6 9.375v1.5m0-5.25v5.25m0-5.25C6 5.004 6.504 4.5 7.125 4.5h9.75c.621 0 1.125.504 1.125 1.125m1.125 2.625h1.5m-1.5 0A1.125 1.125 0 0 1 18 7.125v-1.5m1.125 2.625c-.621 0-1.125.504-1.125 1.125v1.5m2.625-2.625c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125M18 5.625v5.25M7.125 12h9.75m-9.75 0A1.125 1.125 0 0 1 6 10.875M7.125 12C6.504 12 6 12.504 6 13.125m0-2.25C6 11.496 5.496 12 4.875 12M18 10.875c0 .621-.504 1.125-1.125 1.125M18 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m-12 5.25v-5.25m0 5.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125m-12 0v-1.5c0-.621-.504-1.125-1.125-1.125M18 18.375v-5.25m0 5.25v-1.5c0-.621.504-1.125 1.125-1.125M18 13.125v1.5c0 .621.504 1.125 1.125 1.125M18 13.125c0-.621.504-1.125 1.125-1.125M6 13.125v1.5c0 .621-.504 1.125-1.125 1.125M6 13.125C6 12.504 5.496 12 4.875 12m-1.5 0h1.5m-1.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M19.125 12h1.5m0 0c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h1.5m14.25 0h1.5" />
                                        </svg>
                                        break;
                                }

                                <div class="pointer-events-none bg-transparent group-hover:bg-black/60 transition-all duration-500 ease-in-out absolute inset-0"></div>

                                <div class="absolute px-1 left-0 right-0 bottom-0 text-white translate-y-full group-hover:translate-y-0 transition-transform duration-500 ease-in-out whitespace-nowrap overflow-hidden text-ellipsis">
                                    @uploadingFile.BrowserFile.Name
                                </div>
                            </div>
                            
                            <span class="absolute z-10 -right-1 -top-1 border border-gray-600 bg-gray-700 rounded-lg p-0.5 hidden group-hover:flex flex-row">
                                @{ int index = i; }

                                <button class="p-1 bg-transparent hover:bg-white/15 cursor-pointer rounded-lg" @onclick="@(() => HandleToggleUploadingFileSpoiler(uploadingFile.Id))">
                                    @if (uploadingFile.Spoiler) {
                                        <Eye class="size-5 fill-white"/>
                                    } else {
                                        <EyeSlash class="size-5 fill-white"/>
                                    }
                                </button>

                                <button class="p-1 bg-transparent hover:bg-white/15 cursor-pointer rounded-lg" @onclick="@(() => HandleRemoveUploadingFile(uploadingFile.Id))">
                                    <Trashcan class="size-5 fill-red-500"/>
                                </button>
                            </span>
                        </div>
                    </li>
                }
            </ul>
        }

        @{ string textAreaCssClass = $"shrink-0 input-field w-full py-2 overflow-x-hidden overflow-y-auto wrap-break-word break-all resize-none scrollbar-hide shadow-lg max-h-96 {(_replyMessageId.HasValue || _uploadingFiles.Count > 0 ? "rounded-t-none" : string.Empty)}"; }

        <MessageTextArea @bind-Value="_body" class="@textAreaCssClass" OnEnterSubmit="HandleMessageSubmit"/>
    </section>
    
    <label class="flex-none rounded-full bg-transparent hover:bg-white/15 active:bg-black/15 p-2 cursor-pointer group disabled:bg-transparent disabled:cursor-default" disabled="@_disabled">
        <Paperclip class="size-6 fill-white group-disabled:fill-gray-400"/>

        <AccumulatedInputFile @ref="_inputFile" OnChange="HandleAttachmentChanged"></AccumulatedInputFile>
    </label>
    
    <button class="flex-none rounded-full bg-transparent hover:bg-white/15 active:bg-black/15 p-2 cursor-pointer group disabled:bg-transparent disabled:cursor-default" disabled="@_disabled">
        <Media Type="MediaType.Gif" class="size-6 fill-none stroke-white group-disabled:stroke-gray-400"/>
    </button>
</footer>

<Dialog @bind-Open="_reportSurpassedAttachmentMaxCount" OnClickOutside="CloseAttachmentCountReport" class="flex justify-center items-center" ContainerCssClass="flex justify-center items-center">
    <Card>
        <CardHeader Title="Too much file..." OnCloseRequested="CloseAttachmentCountReport"/>
        
        <CardContent>
            <p>
                Whoa there buddy, you cannot send this much file for the time being.
                <br/>
                If you need to send more, attach it to another message.
            </p>
        </CardContent>
        
        <CardFooter class="mt-2 flex flex-row justify-end gap-2 border-none!">
            <button class="button-primary w-24" @onclick="CloseAttachmentCountReport">Ok</button>
        </CardFooter>
    </Card>
</Dialog>

<Dialog @bind-Open="_reportAttachmentSurpassedMaxSize" OnClickOutside="CloseAttachmentSizeReport" class="flex justify-center items-center" ContainerCssClass="flex justify-center items-center">
    <Card>
        <CardHeader Title="Comically large file detected!" OnCloseRequested="CloseAttachmentSizeReport"/>
        
        <CardContent>
            <p>
                Whoa there buddy, one of the files you want to transfer over is way too large.
                <br/>
                You will have to find another way to send these files. Either compress them or <i>cough cough</i> use third party services <i>cough</i>.
            </p>
        </CardContent>
        
        <CardFooter class="mt-2 flex flex-row justify-end gap-2 border-none!">
            <button class="button-primary w-24" @onclick="CloseAttachmentSizeReport">Ok</button>
        </CardFooter>
    </Card>
</Dialog>

@code {
    [Parameter] public EventCallback<MessageData> OnSubmit { get; set; }
    
    [Parameter] public Guid? ReplyMessageId { get; set; }
    [Parameter] public EventCallback<Guid?> ReplyMessageIdChanged { get; set; }

    [Parameter(CaptureUnmatchedValues = true)] public IReadOnlyDictionary<string, object>? AdditionalAttributes { get; set; }
    private bool _disabled;
    private string? _cssClass;
    
    private string? _body;
    private Guid? _previousReplyMessageId, _replyMessageId;
    
    private ReplyMessageDTO _replyMessageData;
    private List<UploadingFile> _uploadingFiles = [];
    private int _numberOfInputFiles = 1;
    
    private bool _reportSurpassedAttachmentMaxCount;
    private bool _reportAttachmentSurpassedMaxSize;

    private AccumulatedInputFile _inputFile = null!;
    
    protected override void OnParametersSet() {
        if (AdditionalAttributes != null) {
            if (AdditionalAttributes.TryGetValue("disabled", out object? obj)) {
                _disabled = Convert.ToBoolean(obj);
            }
            
            if (AdditionalAttributes.TryGetValue("class", out obj)) {
                _cssClass = Convert.ToString(obj);
            }
        }

        AdditionalAttributes = AdditionalAttributes?.Where(x => x.Key is not "disabled" and not "class").ToDictionary();
        _replyMessageId = ReplyMessageId;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (_previousReplyMessageId != _replyMessageId && _replyMessageId.HasValue) {
            await using (var dbContext = await DbContextFactory.CreateDbContextAsync()) {
                _replyMessageData = await dbContext.ChatMessages
                    .Where(m => m.Id == _replyMessageId.Value && m.DeletedAt == null)
                    .Select(m => new ReplyMessageDTO {
                        AuthorDisplayName = m.Sender.DisplayName,
                        MessageBody = m.Body,
                    })
                    .FirstOrDefaultAsync();
                
                StateHasChanged();
            }
        }

        _previousReplyMessageId = _replyMessageId;
    }

    [JSInvokable]
    public async Task HandleMessageSubmit() {
        _body = _body?.Trim();
        
        if (_disabled || (string.IsNullOrEmpty(_body) && _uploadingFiles.Count == 0)) return;

        if (OnSubmit.HasDelegate) {
            await OnSubmit.InvokeAsync(new(_body, _replyMessageId, _uploadingFiles));
        }

        _replyMessageId = null;
        await ReplyMessageIdChanged.InvokeAsync(_replyMessageId);

        await DisposeUploadingFiles();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleAttachmentChanged(AccumulatedInputFileChangeEventArgs args) {
        IReadOnlyList<IBrowserFile> files;

        try {
            files = args.ChangeEventArgs.GetMultipleFiles(ApplicationConstants.MaxAttachmentsPerMessage);
        } catch (InvalidOperationException) {
            _reportSurpassedAttachmentMaxCount = true;
            return;
        }

        // Validate attachment count.
        if (_uploadingFiles.Count + files.Count > ApplicationConstants.MaxAttachmentsPerMessage) {
            _reportSurpassedAttachmentMaxCount = true;
            return;
        }

        // Validate attachment size.
        for (int i = 0; i < files.Count; i++) {
            if (files[i].Size > ApplicationConstants.MaxSizePerAttachment) {
                _reportAttachmentSurpassedMaxSize = true;
                return;
            }
        }
        
        _numberOfInputFiles++;
        
        for (int i = 0; i < files.Count; i++) {
            IBrowserFile file = files[i];
            string? previewUrl = file.ContentType switch {
                _ when file.ContentType.StartsWith("image/") => await JavascriptRuntime.InvokeAsync<string>("window.createInputPreviewUrl", args.Owner.Element, i),
                _ => null,
            };

            _uploadingFiles.Add(new(Guid.CreateVersion7(), file, previewUrl, false));
        }
    }

    private void CloseAttachmentCountReport() {
        _reportSurpassedAttachmentMaxCount = false;
    }

    private void CloseAttachmentSizeReport() {
        _reportAttachmentSurpassedMaxSize = false;
    }

    private async Task HandleCancelReply() {
        _replyMessageData = default;
        _replyMessageId = null;
        
        await ReplyMessageIdChanged.InvokeAsync(_replyMessageId);
    }

    private void HandleToggleUploadingFileSpoiler(Guid id) {
        int index = 0;

        for (; index < _uploadingFiles.Count; index++) {
            if (_uploadingFiles[index].Id == id) {
                break;
            }
        }

        if (index == _uploadingFiles.Count) {
            return;
        }

        UploadingFile file = _uploadingFiles[index];
        
        _uploadingFiles[index] = file with {
            Spoiler = !file.Spoiler,
        };
    }

    private async Task HandleRemoveUploadingFile(Guid id) {
        int index = 0;

        for (; index < _uploadingFiles.Count; index++) {
            if (_uploadingFiles[index].Id == id) {
                break;
            }
        }

        if (index == _uploadingFiles.Count) {
            return;
        }

        UploadingFile file = _uploadingFiles[index];

        if (!string.IsNullOrEmpty(file.PreviewUrl)) {
            await JavascriptRuntime.InvokeVoidAsync("URL.revokeObjectURL", file.PreviewUrl);
        }
        
        _uploadingFiles.RemoveAt(index);
    }

    private async Task DisposeUploadingFiles() {
        for (int i = 0; i < _uploadingFiles.Count; i++) {
            if (_uploadingFiles[i].PreviewUrl is { } previewUrl) {
                await JavascriptRuntime.InvokeVoidAsync("URL.revokeObjectURL", previewUrl);
            }
        }

        _uploadingFiles.Clear();
    }

    public async ValueTask DisposeAsync() {
        await DisposeUploadingFiles();
    }

    private readonly record struct ReplyMessageDTO(string AuthorDisplayName, string? MessageBody);

    public readonly record struct UploadingFile(Guid Id, IBrowserFile BrowserFile, string? PreviewUrl, bool Spoiler);
    public readonly record struct MessageData(string? Body, Guid? ReplyMessageId, IReadOnlyList<UploadingFile> UploadingFiles);
}