@using Conflux.Components.Shared.Icons
@using Conflux.Database
@using Microsoft.EntityFrameworkCore

@implements IAsyncDisposable

@inject IJSRuntime JavascriptRuntime
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject ILogger<MessageInputArea> Logger

<footer class="flex flex-row items-end gap-1 @_cssClass" @attributes="AdditionalAttributes">
    <section class="flex-1 flex flex-col min-w-0">
        @if (_replyMessageId != null) {
            <div class="min-w-0 rounded-t-lg py-1 px-2 border-x border-t border-x-gray-600 border-t-gray-600 flex flex-row items-center gap-1 overflow-hidden">
                <p class="flex-1 whitespace-nowrap overflow-hidden text-ellipsis">Replying to @_replyMessageData.AuthorDisplayName: "@_replyMessageData.MessageBody"</p>

                <button class="flex-none p-0.5 bg-transparent hover:bg-white/15 rounded-full" @onclick="HandleCancelReply">
                    <Cross class="size-4 fill-white"></Cross>
                </button>
            </div>
        }

        <textarea @ref="_textareaElement"
            class="shrink-0 input-field @(_replyMessageId == null ? string.Empty : "rounded-t-none") w-full py-2 max-h-96 overflow-x-hidden overflow-y-auto wrap-break-word break-all resize-none scrollbar-hide shadow-lg"
            rows="1"
            placeholder="Enter the message..."
            disabled="@_disabled"
            @bind="TextBody" @bind:event="oninput">
        </textarea>
    </section>

    <button class="flex-none rounded-full bg-transparent hover:bg-white/15 active:bg-black/15 p-2 cursor-pointer group disabled:bg-transparent disabled:cursor-default" disabled="@_disabled">
        <Paperclip class="size-6 fill-white group-disabled:fill-gray-400"/>
    </button>

    <button class="flex-none rounded-full bg-transparent hover:bg-white/15 active:bg-black/15 p-2 cursor-pointer group disabled:bg-transparent disabled:cursor-default" disabled="@_disabled">
        <Media Type="MediaType.Gif" class="size-6 fill-none stroke-white group-disabled:stroke-gray-400"/>
    </button>
</footer>

@code {
    [Parameter] public EventCallback<MessageData> OnSubmit { get; set; }
    
    [Parameter] public Guid? ReplyMessageId { get; set; }
    [Parameter] public EventCallback<Guid?> ReplyMessageIdChanged { get; set; }

    private Guid? _replyMessageId;
    
    public string TextBody { get; set; } = string.Empty;

    private ElementReference _textareaElement;
    
    private IJSObjectReference? _module;
    private DotNetObjectReference<MessageInputArea>? _objectReference;

    private ReplyMessageDTO _replyMessageData;
    
    [Parameter(CaptureUnmatchedValues = true)] public IReadOnlyDictionary<string, object>? AdditionalAttributes { get; set; }
    private bool _disabled;
    private string? _cssClass;

    protected override void OnParametersSet() {
        if (AdditionalAttributes != null) {
            if (AdditionalAttributes.TryGetValue("disabled", out object? obj)) {
                _disabled = Convert.ToBoolean(obj);
            }
            
            if (AdditionalAttributes.TryGetValue("class", out obj)) {
                _cssClass = Convert.ToString(obj);
            }
        }

        AdditionalAttributes = AdditionalAttributes?.Where(x => x.Key is not "disabled" and not "class").ToDictionary();

        _replyMessageId = ReplyMessageId;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            _module = await JavascriptRuntime.InvokeAsync<IJSObjectReference>("import",
                "./Components/Shared/MessageInputArea.razor.js");
            
            _objectReference = DotNetObjectReference.Create(this);
            await _module.InvokeVoidAsync("initializeTextArea", _textareaElement, _objectReference);
        }

        if (_replyMessageId != null) {
            await using (var dbContext = await DbContextFactory.CreateDbContextAsync()) {
                _replyMessageData = await dbContext.ChatMessages
                    .Where(m => m.Id == _replyMessageId.Value && m.DeletedAt == null)
                    .Select(m => new ReplyMessageDTO {
                        AuthorDisplayName = m.Sender.DisplayName,
                        MessageBody = m.Body,
                    })
                    .FirstOrDefaultAsync();
                
                StateHasChanged();
            }
        } else {
            _replyMessageData = default;
        }
    }

    [JSInvokable]
    public async Task HandleMessageSubmit() {
        TextBody = TextBody.Trim();
        
        if (_disabled || string.IsNullOrEmpty(TextBody)) return;

        if (OnSubmit.HasDelegate) {
            await OnSubmit.InvokeAsync(new(TextBody, _replyMessageId));
        }
        
        TextBody = string.Empty;
        await SetReplyMessageId(null);
        
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync() {
        if (_module is not null) {
            try {
                await _module.DisposeAsync();
            } catch (JSDisconnectedException) {
            }
        }

        _objectReference?.Dispose();
    }

    public async Task SetReplyMessageId(Guid? id) {
        _replyMessageId = id;
        await ReplyMessageIdChanged.InvokeAsync(_replyMessageId);
    }

    private async Task HandleCancelReply() {
        _replyMessageData = default;
        await SetReplyMessageId(null);
    }

    private readonly record struct ReplyMessageDTO(string AuthorDisplayName, string MessageBody);

    public readonly record struct MessageData(string Body, Guid? ReplyMessageId);

}