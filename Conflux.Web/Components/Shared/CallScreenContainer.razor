@using Conflux.Web.Core
@using Conflux.Web.Services.Abstracts
@using System.Security.Claims

@implements IDisposable

@inject IUserCallService UserCallService
@inject IWebUserNotificationService UserNotificationService

<div class="fixed inset-4 z-100000 pointer-events-none">
    <CascadingValue Value="_userId" Name="SessionUserId">
        @foreach (var room in UserCallService.JoinedRooms) {
            <CallScreen @key="room.Id" CallRoom="room"/>
        }
    </CascadingValue>
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationState { get; set; } = null!;
    private Guid _userId;
    
    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (firstRender) {
            var authState = await AuthenticationState;

            if (authState.User.FindFirstValue(ClaimTypes.NameIdentifier) is not { } id ||
                !Guid.TryParse(id, out _userId)) {
                return;
            }
            
            UserCallService.OnCallJoined += OnUserCallJoined;
            UserCallService.OnOfferReceived += OnOfferReceived;
            UserNotificationService.OnIncomingCall += OnIncomingCall;
            UserCallService.OnCallLeft += OnCallLeft;
        }
    }

    private void OnUserCallJoined() {
        StateHasChanged();
    }

    private void OnOfferReceived(CallRoom room) {
        InvokeAsync(StateHasChanged);
    }

    private async Task OnIncomingCall(IncomingCallEventArgs args) {
        await InvokeAsync(StateHasChanged);
    }

    private void OnCallLeft(Guid callId) {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose() {
        UserCallService.OnCallJoined -= OnUserCallJoined;
        UserCallService.OnOfferReceived -= OnOfferReceived;
        UserNotificationService.OnIncomingCall -= OnIncomingCall;
        UserCallService.OnCallLeft -= OnCallLeft;
    }
}