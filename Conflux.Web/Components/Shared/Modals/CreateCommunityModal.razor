@using Conflux.Web.Services
@using System.Security.Claims

@inherits BaseModal

@inject ICommunityService CommunityService
@inject ApplicationRedirectManager RedirectManager

<div class="flex flex-row justify-center items-center size-full text-white">
    @switch (_state) {
        case State.TemplateSelection:
            <Card class="z-10 overflow-hidden">
                <CardHeader Title="Create Your Own Paradise" Subtext="A community will need a place to stay. Make your own paradise and start chatting." OnCloseRequested="@((Action<object?>)CloseModal)"/>

                <CardContent class="pb-3">
                    <button class="border border-gray-600 bg-black/5 hover:bg-black/2 active:bg-black/8 w-full p-3 rounded-lg shadow-lg cursor-pointer" @onclick="() => _state = State.InputInfo">
                        Create a fresh server
                    </button>
                </CardContent>
            </Card>
            break;
            
        case State.InputInfo:
            <Card class="z-10 overflow-hidden">
                <CardHeader Title="Input Information" Subtext="Give your new home a name, a face and a new life." OnCloseRequested="@((Action<object?>)CloseModal)"/>

                <CardContent class="pb-3">
                    <CreateCommunityForm OnRequestCreateServer="HandleCreateServer"/>
                </CardContent>
            </Card>
            break;
    }
</div>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthenticationState { get; set; } = null!;
    
    private State _state;
    private Guid _userId;

    protected override async Task OnParametersSetAsync() {
        var authState = await AuthenticationState;

        if (authState.User.FindFirstValue(ClaimTypes.NameIdentifier) is not { } id ||
            !Guid.TryParse(id, out _userId))
        {
            RedirectManager.To("/").Execute();
        }
    }

    private async Task HandleCreateServer(CreateCommunityForm.InputModel model) {
        if (model.Avatar == null) {
            await CommunityService.CreateCommunityAsync(model.Name, null, _userId);
        } else {
            await using var avatarStream = model.Avatar.OpenReadStream(ApplicationConstants.MaxCommunityAvatarSize);

            await CommunityService.CreateCommunityAsync(model.Name, avatarStream, _userId);
        }

        CloseModal();
    }

    private enum State {
        TemplateSelection,
        InputInfo,
    }
}