@using Conflux.Application.Dto
@using Conflux.Web.Components.Shared.Modals
@using Conflux.Web.Helpers
@using Conflux.Web.Services.Implementations

@inject IReportService ReportService
@inject IContentService ContentService
@inject ModalService ModalService

<div class="flex flex-col h-full gap-1 overflow-y-auto">
    <header class="flex-none ml-2">
        <h1 class="text-xl font-bold">Reports</h1>
        <p class="text-sm text-gray-400">The naughty list</p>
    </header>
    
    <section class="flex-1 h-full min-h-0 px-2">
        <Collapsible class="w-full mt-2 border-b border-b-gray-600 pb-1.5" @bind-IsExpanded:get="_statisticCollapsible" @bind-IsExpanded:set="SetStatisticsCollapsible">
            <HeaderContent>
                <span class="font-semibold">Statistics</span>
            </HeaderContent>
            
            <ChildContent>
                @if (_countStatistics == null) {
                    <div class="flex flex-row justify-center items-center">
                        <Spinner class="size-8 fill-white"/>
                    </div>
                } else {
                    var countStatistic = _countStatistics.Value;
                    
                    <section class="mt-2 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-2">
                        <div class="border border-gray-600 shadow-md rounded-lg p-2">
                            <p>Total report count:</p>

                            <div class="mt-3 flex justify-end">
                                <p class="text-3xl">@countStatistic.Total</p>
                            </div>
                        </div>

                        <div class="border border-gray-600 shadow-md rounded-lg p-2">
                            <div class="flex flex-row gap-2 items-center">
                                <p class="flex-none">
                                    Report count
                                </p>

                                <SelectionDropdown @bind-Value="_countTimeTarget" ContainerCssClass="flex-1" ButtonCssClass="w-full h-9" PopoverCssClass="w-full">
                                    <ValueDisplayContent>
                                        @switch (_countTimeTarget) {
                                            case ReportCountTimeTarget.Today:
                                                <p>Today</p>
                                                break;
                                                
                                            case ReportCountTimeTarget.ThisMonth:
                                                <p>This Month</p>
                                                break;
                                                
                                            case ReportCountTimeTarget.ThisYear:
                                                <p>This Year</p>
                                                break;
                                        }
                                    </ValueDisplayContent>
                                    
                                    <ChildContent>
                                        <SelectionOption class="px-1.5 py-1 text-left button-nav-menu" Value="@ReportCountTimeTarget.Today">Today</SelectionOption>
                                        <SelectionOption class="px-1.5 py-1 text-left button-nav-menu" Value="@ReportCountTimeTarget.ThisMonth">This Month</SelectionOption>
                                        <SelectionOption class="px-1.5 py-1 text-left button-nav-menu" Value="@ReportCountTimeTarget.ThisYear">This Year</SelectionOption>
                                    </ChildContent>
                                </SelectionDropdown>
                            </div>

                            <div class="mt-1 flex justify-end">
                                @switch (_countTimeTarget) {
                                    case ReportCountTimeTarget.Today:
                                        <p class="text-3xl">@countStatistic.Today</p>
                                        break;
                                                
                                    case ReportCountTimeTarget.ThisMonth:
                                        <p class="text-3xl">@countStatistic.ThisMonth</p>
                                        break;
                                                
                                    case ReportCountTimeTarget.ThisYear:
                                        <p class="text-3xl">@countStatistic.ThisYear</p>
                                        break;
                                }
                            </div>
                        </div>

                        <div class="border border-gray-600 shadow-md rounded-lg p-2">
                            <p>Resolved Percentage:</p>

                            <div class="mt-3 flex justify-end">
                                <p class="text-3xl">@(((float)countStatistic.Resolved / countStatistic.Total).ToString("P2"))</p>
                            </div>
                        </div>
                    </section>
                }
                
            </ChildContent>
        </Collapsible>
        
        <Collapsible class="w-full mt-2 border-b border-b-gray-600 pb-1.5" @bind-IsExpanded:get="_reportsCollapsible" @bind-IsExpanded:set="SetReportCollapsible">
            <HeaderContent>
                <span class="font-semibold">Reports</span>
            </HeaderContent>
            
            <ChildContent>
                <div class="block lg:flex lg:flex-row lg:gap-2 mt-2">
                    <section class="lg:flex-1 h-128 border border-gray-600 rounded-md overflow-y-auto p-1 scrollbar-hide overscroll-y-contain">
                        @{ Guid selectedMemberId = _selectedMemberInfo?.MemberId ?? Guid.Empty; }
                        
                        <Virtualize ItemsProvider="GetReportedMembers">
                            <ItemContent Context="item">
                                @{ string cssClass = item.MemberId == selectedMemberId ? "h-10 bg-white/8" : "h-10"; }

                                <UserCard AvatarSrc="@(string.IsNullOrEmpty(item.AvatarPath) ? null : ContentService.GetAssetPath(item.AvatarPath))"
                                          DisplayName="@item.DisplayName"
                                          UserId="@item.UserId"
                                          MemberId="@item.MemberId"
                                          class="@cssClass"
                                          OnClick="HandleReportedMemberSelection"/>
                            </ItemContent>
                        </Virtualize>
                    </section>
                    
                    <section class="mt-2 lg:mt-0 lg:flex-3 h-128 border border-gray-600 rounded-md overflow-y-auto p-2 scrollbar-hide overscroll-y-contain">
                        @if (_selectedMemberInfo == null) {
                            <div class="size-full flex flex-row justify-center items-center">
                                <p class="text-sm text-gray-400">Select a User to view their history.</p>
                            </div>
                        } else {
                            if (_selectedMemberStatistics == null) {
                                <div class="size-full flex flex-row justify-center items-center">
                                    <p class="text-sm text-gray-400">Failed to fetch member report history.</p>
                                </div>
                            } else {
                                var memberStats = _selectedMemberStatistics.Value;

                                <h1 class="text-2xl font-bold">Report Information</h1>
                                
                                <section class="mt-2">
                                    <h2 class="text-xl font-semibold">Member Information</h2>
                                    
                                    <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                        <Card class="border border-gray-600 shadow-md">
                                            <CardContent class="flex flex-row justify-between items-center px-2!">
                                                <p>Report Count</p>
                                                
                                                <p>@memberStats.TotalReportCount</p>
                                            </CardContent>
                                        </Card>
                                        
                                        <Card class="border border-gray-600 shadow-md">
                                            <CardContent class="flex flex-row justify-between items-center px-2!">
                                                <p>Resolved Count</p>
                                                
                                                <p>@memberStats.ResolvedReportCount</p>
                                            </CardContent>
                                        </Card>
                                            
                                        <Card class="border border-gray-600 shadow-md">
                                            <CardContent class="flex flex-row justify-between items-center px-2!">
                                                <p>Resolved Percentage</p>
                                                    
                                                <p>@((memberStats.ResolvedReportCount / memberStats.TotalReportCount).ToString("P2"))</p>
                                            </CardContent>
                                        </Card>
                                    </div>
                                </section>
                                
                                <section class="mt-2">
                                    <h2 class="text-xl font-semibold">Reported Messages</h2>
                                    
                                    <div class="mt-2 flex flex-row justify-center items-center">
                                        <button class="button-primary" @onclick="EventUtils.AsNonRenderingEventHandler(OpenReportManagementModal)">Open Report Management</button>
                                    </div>
                                </section>
                            }
                        }
                    </section>
                </div>
            </ChildContent>
        </Collapsible>
    </section>
</div>

@code {
    [Parameter, EditorRequired] public required Guid CommunityId { get; set; }

    private ReportCountStatistics? _countStatistics;
    private ReportCountTimeTarget _countTimeTarget;

    private bool _statisticCollapsible;
    private bool _reportsCollapsible;

    private SelectedMemberInfo? _selectedMemberInfo;
    private MemberReportStatistics? _selectedMemberStatistics;
    
    [CascadingParameter] private MemberInformationDTO? MemberInformation { get; set; }
    private MemberInformationDTO _memberInformation;

    protected override void OnParametersSet() {
        if (MemberInformation == null) {
            throw new InvalidOperationException($"Cascading parameter type '{typeof(MemberInformationDTO).FullName}' MemberInformation need to be set.");
        }

        _memberInformation = MemberInformation.Value;
    }

    private async Task SetStatisticsCollapsible(bool value) {
        if (value && _countStatistics == null) {
            _countStatistics = await ReportService.GetReportCountStatisticsAsync(CommunityId);
        }

        _statisticCollapsible = value;
    }

    private void SetReportCollapsible(bool value) {
        _reportsCollapsible = value;
    }

    private async ValueTask<ItemsProviderResult<MemberDisplayDTO>> GetReportedMembers(ItemsProviderRequest request) {
        var result = await ReportService.PaginateReportedMembersAsync(CommunityId, request.StartIndex, request.Count);

        return new(result.Page, result.Count);
    }

    private async Task HandleReportedMemberSelection(UserCard card) {
        _selectedMemberInfo = new(card.MemberId!.Value, card.UserId);
        _selectedMemberStatistics = await ReportService.GetMemberReportStatisticsAsync(card.MemberId!.Value);
    }

    private void OpenReportManagementModal() {
        if (_selectedMemberInfo is not { } memberInfo) {
            return;
        }
        
        ModalService.Open<ReportManagementModal>(parameters: new Dictionary<string, object?> {
            [nameof(ReportManagementModal.CommunityId)] = CommunityId,
            [nameof(ReportManagementModal.ReportedMemberId)] = memberInfo.MemberId,
            [nameof(ReportManagementModal.ResolvingMemberId)] = _memberInformation.MemberId,
            [nameof(ReportManagementModal.Permissions)] = _memberInformation.Role.Permissions,
        });
    }

    private enum ReportCountTimeTarget {
        Today,
        ThisMonth,
        ThisYear,
    }

    private readonly record struct SelectedMemberInfo(Guid MemberId, Guid UserId);
}