@page "/auth/login"

@using Microsoft.AspNetCore.Identity
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Sections

@attribute [ExcludeFromInteractiveRouting]

@inject IWebHostEnvironment Environment
@inject IViteManifest ViteManifest
@inject IViteDevServerStatus Vite
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager

<div class="fixed bg-fixed inset-0 morph-gradient-bg">
    <svg xmlns="http://www.w3.org/2000/svg" class="size-0">
        <defs>
            <filter id="filter">
                <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur"/>
                <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0   0 1 0 0 0   0 0 1 0 0   0 0 0 18 -8" result="bg"/>
                <feBlend in="SourceGraphic" in2="bg"/>
            </filter>
        </defs>
    </svg>

    <div class="morph-gradient-container">
        <div class="gradient-element-1"></div>
        <div class="gradient-element-2"></div>
        <div class="gradient-element-3"></div>
        <div class="gradient-element-4"></div>
        <div class="gradient-element-5"></div>
    </div>
</div>

<div class="w-dvw h-dvh grid grid-cols-1 px-4 md:px-0 md:grid-cols-4 lg:grid-cols-3">
    <div class="col-start-1 col-span-1 md:col-start-2 md:col-span-2 lg:col-start-2 lg:col-span-1">
        <div class="size-full flex flex-row justify-center items-center">
            <div class="bg-gray-700 w-full rounded-3xl shadow-xl text-white overflow-visible relative">
                <div class="absolute rounded-t-3xl h-12 w-full overflow-hidden">
                    <div class="h-1 panel-accent-color-1"></div>
                </div>

                <section class="p-10">
                    <h1 class="text-center font-bold text-3xl text-white">Welcome Back</h1>
                    <p class="text-center text-gray-400 text-sm mt-2">Identify yourself</p>

                    <EditForm method="post" class="mt-8" FormName="Login" EditContext="_editContext" OnValidSubmit="OnValidSubmit">
                        <DataAnnotationsValidator/>

                        <div>
                            <label class="text-sm text-gray-300">Email</label>

                            <InputText type="text" @bind-Value="Model.Email" placeholder="Enter Email" class="w-full h-11 mt-2 px-3 input-field"/>
                        </div>

                        <div class="mt-4">
                            <label class="text-sm text-gray-300">Password</label>

                            <SensitiveInputText class="w-full mt-2 h-11" @bind-Value="Model.Password" placeholder="Enter Password" InputCssClass="w-full h-11 input-field rounded-r-none border-r-0">
                                <ShowButtonContent>
                                    <Eye class="size-6 fill-white"/>
                                </ShowButtonContent>

                                <HideButtonContent>
                                    <EyeSlash class="size-6 fill-white"/>
                                </HideButtonContent>
                            </SensitiveInputText>
                        </div>

                        <div class="flex items-center justify-between text-sm text-gray-400 mt-4">
                            <label class="flex items-center space-x-2">
                                <InputCheckbox class="accent-indigo-500" @bind-Value="Model.RememberMe"/>
                                <span>Remember me</span>
                            </label>

                            <a href="#" class="hover:text-indigo-400 transition-colors">Forgot password?</a>
                        </div>

                        @if (!string.IsNullOrEmpty(_errorMessage)) {
                            <p class="text-center mt-1 text-red-500">@_errorMessage</p>
                        }

                        <button type="submit" class="w-full h-11 button-color-1 rounded-lg text-white font-semibold shadow-md transition-colors duration-300 mt-4 cursor-pointer">
                            Log In
                        </button>
                    </EditForm>

                    <p class="text-center text-gray-400 text-sm mt-2">
                        No account? Click <a class="underline cursor-pointer" href="/auth/register">here</a> to create one.
                    </p>
                    
                    <p class="text-center text-gray-400 text-sm mt-1">
                        Or you can login with...
                        
                        <span class="flex flex-row gap-2 flex-wrap justify-center mt-2">
                            @{
                                var parameters = new Dictionary<string, object?> {
                                    ["Provider"] = "Google",
                                };
                                
                                string redirectUrl = NavigationManager.GetUriWithQueryParameters("/auth/external-login", parameters);
                            }
                            
                            <NavLink href="@redirectUrl">
                                <svg xmlns="http://www.w3.org/2000/svg" class="size-6 fill-white" viewBox="0 0 16 16">
                                    <path d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z"/>
                                </svg>
                            </NavLink>
                        </span>
                    </p>
                </section>
            </div>
        </div>
    </div>
</div>

<SectionContent SectionName="javascript">
    @if (Environment.IsDevelopment() && Vite.IsMiddlewareEnable) {
        <StaticPageScript Src="./js/Pages/LoginPage.js"></StaticPageScript>
    } else {
        IViteChunk? chunk;
        
        if ((chunk = ViteManifest["scripts/Pages/LoginPage.ts"]) != null) {
            <StaticPageScript Src="@chunk.File"></StaticPageScript>

            if (chunk.Imports != null) {
                foreach (string import in chunk.Imports) {
                    if (!ViteManifest.ContainsKey(import)) continue;

                    <StaticPageScript Src="@ViteManifest[import]!.File"></StaticPageScript>
                }
            }
        }
    }
</SectionContent>

@code {
    private EditContext _editContext = null!;
    [SupplyParameterFromForm(FormName = "Login")] private InputModel Model { get; set; } = null!;
    private string? _errorMessage;

    [CascadingParameter] public HttpContext HttpContext { get; set; } = null!;

    [SupplyParameterFromQuery(Name = "ReturnUrl")] private string? ReturnUrl { get; set; }

    // [CascadingParameter] private Task<AuthenticationState> AuthenticationState { get; set; } = null!;
    //
    // protected override async Task OnInitializedAsync() {
    //     // If already login, kick the user out.
    //     if (await AuthenticationState is { User.Identity.IsAuthenticated: true }) {
    //         NavigationManager.NavigateTo("/", true);
    //         return;
    //     }
    //
    //     Model ??= new();
    //     _editContext = new(Model);
    // }
    
    protected override void OnInitialized() {
        if (HttpContext.User.Identity?.IsAuthenticated ?? false) {
            NavigationManager.NavigateTo("/", true);
            return;
        }
    
        Model ??= new();
        _editContext = new(Model);
    }
    
    private async Task OnValidSubmit() {
        var user = await UserManager.FindByEmailAsync(Model.Email);

        if (user == null) {
            _errorMessage = "Invalid login credential.";
            return;
        }

        var result = await SignInManager.PasswordSignInAsync(user, Model.Password, Model.RememberMe, false);

        if (result.Succeeded) {
            if (await UserManager.IsEmailConfirmedAsync(user)) {
                if (user.IsProfileSetup) {
                    NavigationManager.NavigateTo(ReturnUrl ?? "/");
                } else {
                    string destination = NavigationManager.GetUriWithQueryParameters("/setup-profile", new Dictionary<string, object?> {
                        ["ReturnUrl"] = ReturnUrl,
                    });
                    NavigationManager.NavigateTo(destination);
                }
            } else {
                string destination = NavigationManager.GetUriWithQueryParameters("/auth/verify-email", new Dictionary<string, object?> {
                    ["UserId"] = user.Id,
                });
                NavigationManager.NavigateTo(destination);
            }
        } else {
            _errorMessage = "Invalid login credential.";
        }
    }

    private sealed class InputModel {
        [Required]
        [StringLength(320, ErrorMessage = "Email cannot be longer than 320 characters.")]
        [EmailAddress]
        public string Email { get; set; } = string.Empty;
        
        [Required]
        [MinLength(8, ErrorMessage = "Password must be longer or equal to 8 characters.")]
        public string Password { get; set; } = string.Empty;
        
        public bool RememberMe { get; set; }
    }
}